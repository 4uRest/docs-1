# Система лояльности

Чаще всего приложения лояльности выполняют две функции в POS системе — накопление и списание бонусов. 
Чтобы решить эти задачи, можно встроить виджет в рабочее место кассира. 
Дальше будем называть рабочее место кассира — терминалом.

Терминал дополняют функциями при помощи [POS платформы](/docs/v3/pos/index). 
Чтобы начать разработку посмотрите раздел [Начало работы](/docs/v3/pos/start). 
На Github вы найдете [пример готового приложения системы лояльности](https://github.com/joinposter/pos-platform-boilerplate/tree/master/examples/loyalty).

Давайте разберем следующий сценарий работы. Гость приходит в заведение, заказывает круассан и кофе в сумме на 30 грн. 
И хочет использовать систему лояльности чтобы сэкономить. Весь этот процесс можно разбить на следующие этапы:


### Идентификация гостя

Кассир сканирует QR-код или гость диктует свой номер телефона и видит доступные бонусы и персональные данные. Для этого сделайте следующее:

1.  Добавьте кнопку приложения в меню «•••» на экране заказа. Метод [showApplicationIconAt](/docs/v3/pos/interfaces/interface-showApplicationIconAt), вариант «order».
2.  Подпишитесь на событие [applicationIconClicked](/docs/v3/pos/events/applicationIconClicked) и слушайте нажатия на свою кнопку.
3.  При срабатывании события, показывайте попап с вашим интерфейсом методом [interface.popup](/docs/v3/pos/interfaces/interface-popup).
4.  В интерфейсе дайте возможность ввести номер карты лояльности или просканировать QR методом [interface.scanBarcode](/docs/v3/pos/interfaces/interface-scanBarcode).
5.  Методом [makeRequest](/docs/v3/pos/requests/makeRequest) сделайте запрос на ваш сервер и получаете информацию о клиенте и доступных для него скидок.

<img src="/img/site/docs/loyalty-example-1.gif" alt="Пример идентификации гостя">

### Синхронизация базы гостей

После идентификации вы знаете персональные данные гостя и можете добавить его в заказ, чтобы Poster вел статистику покупок. 
Для этого вам нужно сделать следующее: 

1.  Чтобы не дублировать гостей провести поиск по номеру телефона или карте методом [clients.find](/docs/v3/pos/clients/clients-find).
2.  Если не нашли гостя, создать нового методом [clients.create](/docs/v3/pos/clients/clients-create). Чтобы создать гостя, вам нужно указать ему клиентскую группу в Poster. Поэтому создайте группу методом API [clients.createGroup](/docs/v3/web/clients/createGroup). Назовите её названием вашего сервиса и поставьте % скидки 0.
3.  Добавить гостя в заказ методом [orders.setOrderClient](/docs/v3/pos/orders/orders-setOrderClient)


### Использование бонусов

В зависимости от системы лояльности клиент может получать разные вознаграждения. 
Например, 10% скидки на чек или 6й кофе в подарок. Любой из сценариев можно привести к фиксированной скидке. 
Скидку можно применять перед закрытием заказа или на экране оплаты, для этого реализуйте следующий алгоритм:

1.  Подпишитесь на событие закрытия заказа — [beforeOrderClose](/docs/v3/pos/events/beforeOrderClose)
2.  Получите текущий заказ методом [order.getActiveOrder](/docs/v3/pos/orders/orders-getActive) или из ивента [beforeOrderClose](/docs/v3/pos/events/beforeOrderClose).
3.  Проверьте, привязан ли к заказу гость из вашей клиентской группы. Если привязан, покажите ваш интерфейс списания бонусов методом [interface.popup](/docs/v3/pos/interfaces/interface-popup).
4.  Выставите фиксированную скидку методом [orders.setOrderBonus](/docs/v3/pos/orders/orders-setOrderBonus).
5.  Подпишитесь на событие закрытия заказа — [afterOrderClose](/docs/v3/pos/events/afterOrderClose). После закрытия заказа отправляйте запрос на ваш сервер методом [makeRequest](/docs/v3/pos/requests/makeRequest) об успешной оплате и списании бонусов.

Обратите внимание, кассир может в любой момент изменить заказ, удалить товары или добавить новые. 
Отслеживать эти изменения можно событием [orderProductChange](/docs/v3/pos/events/orderProductChange).

<img src="/img/site/docs/loyalty-example-2.gif" alt="Пример установки скидки на заказ">

Это базовый сценарий работы для системы лояльности. Если вы планируете размещаться в каталоге приложений, то вам нужно реализовать все пункты выше. В зависимости от вашей бизнес логики они могут отличаться, и чтобы разместиться в каталоге нужно обсудить изменения с сотрудниками Poster до начала интеграции.



